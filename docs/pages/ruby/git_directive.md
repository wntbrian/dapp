---
title: Добавление кода в образ директивой git
sidebar: ruby
permalink: ruby/git.html
---

Для добавления кода в собираемый образ, предусмотрена директива `git`, с помощью которой можно добавить код из локального или удаленного репозитория (включая сабмодули) как в образ приложения так и в образ артефакта.

При первой сборке образа с указанием директивы `git`, в него добавляется содержимое git репозитория (стадия `g_a_archive`) согласно соответствующих инструкций. При последующих сборках образа, изменения в git репозитории добавляются отдельным docker-слоем, который содержит git-патч (git patch apply). Содержимое таких docker-слоев с патчами также кэшируется, что еще более повышает скорость сборки. В случае отмены сделанных изменений в исходном коде приложения (например, через git revert), при сборке будет накладываться патч с отменой изменений, будет использоваться слой из кэша.

Сборка образов артефактов отличается отсутствием стадии `latest_patch`, т.о. при первой сборке образа артефакта используются текущие состояния git-репозиториев и при последующих сборках образы артефактов не пересобираются (при условии, что отсутствуют зависимости пользовательских стадий от файлов, описанных с помощью директивы `stageDependencies`, о чем см. ниже).

Система кэширования dapp принимает решение о необходимости повторной сборки стадии или использовании кэша, на основании вычисления [сигнатуры стадии]({{ site.baseurl }}/not_used/stages_diagram.html), которая не зависит напрямую от состояния git репозитория. Т.о., если не указать это явно (см далее про директиву `stageDependencies`), то изменения только кода в git репозитории не приведут к повторной сборке пользовательской стадии (`before_install`, `install`, `before_setup`, `setup`, `build_artifact`). Чтобы явно определить зависимость от файлов и папок, при изменении которых сборщику необходимо выполнить принудительную сборку определенных пользовательских стадий, в директиве `git` предусмотрена директива `stageDependencies` (`stage_dependencies` для Ruby синтаксиса).

Правильная установка зависимостей - важное условие построения эффективного процесса сборки!

Количество указаний директивы `git` в описании образа не ограничено, но нужно стремиться к их уменьшению, путем правильного использования `includePaths` и `excludePaths`.

## Общие особенности использования

* пути добавления не должны пересекаться между артефактами;
* описание сборки образа (`dimg` или `artifact`) может содержать любое количество git-директив;
* изменение кода в git репозитории который используется при сборке **образа приложения**, накладывается патчем и не ведет к пересборке какой-либо пользовательской стадии (если нет явного указания зависимости через `stageDependencies`);
* изменение кода в git репозитории который используется при сборке **образа артефакта**, не ведет к пересборке образа артефакта и не накладывается патчем (если нет явного указания зависимости через `stageDependencies`);
* для пересборки пользовательской стадии в зависимости от изменений в git репозитории нужно описывать зависимости с использованием `stageDependencies`;
* поддерживается два типа git-директив, local и remote, для использования локального и удаленного репозитория соответственно;
* при использовании git submodule-й, логика не меняется - инструкции описываются так же, как в случае с директориями;
* для исключения избыточного копирования кода в образ, в директиве `git` предусмотрены параметры `includePaths` и `excludePaths`;
* важно помнить, что код добавленный с помощью директивы `git`, еще не доступен на пользовательской стадии `before install` (см. [подробней]({{ site.baseurl }}/not_used/stages_arhitecture.html) про стадии сборки).

## Cинтаксис

Директива `git [<url>]` позволяет определить один или несколько git-директив.

* Поддерживается два типа git-директив, local и remote.
* Необязательный параметр \<url\> соответствует адресу удалённого git-репозитория (remote).
* Для добавления git-директивы необходимо использовать поддирективу add.
  * Принимает параметр \<cwd\> (по умолчанию используется '\\').
  * Параметры \<include_paths\>, \<exclude_paths\>, \<owner\>, \<group\>, \<to\> определяются в контексте.
  * Параметры \<branch\>, \<commit\> могут быть определены в контексте remote git-директивы.
* В контексте директивы можно указать базовые параметры git-директив, которые могут быть переопределены в контексте каждого из них.
  * \<owner\>.
  * \<group\>.
  * \<branch\>.
  * \<commit\>.


### Параметры артефакта

#### Общие
* to: абсолютный путь, в который будут копироваться ресурсы.
* cwd: абсолютный путь, определяет рабочую директорию.
* include_paths: добавить только указанные относительные пути.
* exclude_paths: игнорировать указанные относительные пути.
* owner: определить пользователя.
* group: определить группу.

#### Дополнительные для remote git-директив
* branch: определить branch.
* commit: определить commit.

#### Управление запуском сборки при изменении файлов

Директива `git.add.stage_dependencies` позволяет определить для пользовательской стадии `install`, `before_setup`, `setup` и `build_artifact` зависимости от файлов git-директивы.

* При изменении содержимого указанных файлов, произойдет пересборка зависимой стадии.
* Учитывается содержимое и имена файлов.
* Поддерживаются glob-паттерны.
* Пути в \<glob\> указываются относительно cwd git-директивы.
* Директории игнорируются.
* \<glob\> чувствителен к регистру.

### Примеры

#### Как собрать образ с несколькими git-директивами
```ruby
dimg do
  docker.from 'image:tag'

  git do
    add '/' do
      exclude_paths 'assets'
      to '/app'
    end

    add '/assets' do
      to '/web/site.narod.ru/assets_with_strange_name'
    end
  end

  git 'https://site.com/com/project.git' do
    owner 'user4'
    group 'stuff'

    add '/' do
      to '/project'
    end
  end
end
```

### Как определить зависимости для нескольких git-директив
```ruby
dimg do
  docker.from 'image:tag'

  git do
    add '/' do
      to '/app'

      stage_dependencies do
        install 'flag'
      end
    end

    add '/assets' do
      to '/web/site.narod.ru/assets_with_strange_name'
      stage_dependencies.setup '*.less'
    end
  end
end
```
