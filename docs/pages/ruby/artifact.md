---
title: Использование артефактов
sidebar: ruby
permalink: ruby/artifact.html
---

Артефакт (artifact) — это набор правил для сборки образа с файловым ресурсом (образа артефакта), который затем используется в одном или нескольких образах приложений. Образ артефакта не используется и не остается после окончания процесса сборки образов приложений, он нужен для изолирования процесса сборки ресурсов, или инструментов сборки (среды, программного обеспечение, данных) от процесса сборки образов приложений, использующих эти ресурсы или инструменты.

Количество артефактов, описываемых в одном dappfile строго не ограничено

Основное различие при использовании разного синтаксиса dappfile в части описания артефактов - в случае с YAML синтаксисом доступен только импорт артефакта, в случае же с ruby синтаксисом, доступен как вариант описания импорта артефакта в образ приложения так и описание экспорта артефакта из образа артефакта.

## Правила использования

* пути добавления не должны пересекаться между артефактами
* изменение любого параметра артефакта ведёт к смене сигнатур, пересборке связанных стадий приложения
* приложение может содержать любое количество артефактов
* артефакты обязаны иметь имя
* имена образов приложений и образов артефактов должны различаться

## Синтаксис

Для добавления артефакта можно использовать директиву export или директиву import.

Директива `git [<url>]` позволяет определить один или несколько git-артефактов.

* Поддерживается два типа git-артефактов, local и remote.
* Необязательный параметр \<url\> соответствует адресу удалённого git-репозитория (remote).
* Для добавления git-артефакта необходимо использовать поддирективу add.
  * Принимает параметр \<cwd\> (по умолчанию используется '\\').
  * Параметры \<include_paths\>, \<exclude_paths\>, \<owner\>, \<group\>, \<to\> определяются в контексте.
  * Параметры \<branch\>, \<commit\> могут быть определены в контексте remote git-артефакта.
* В контексте директивы можно указать базовые параметры git-артефактов, которые могут быть переопределены в контексте каждого из них.
  * \<owner\>.
  * \<group\>.
  * \<branch\>.
  * \<commit\>.

### Параметры артефакта

#### Общие
* to: абсолютный путь, в который будут копироваться ресурсы.
* cwd: абсолютный путь, определяет рабочую директорию.
* include_paths: добавить только указанные относительные пути.
* exclude_paths: игнорировать указанные относительные пути.
* owner: определить пользователя.
* group: определить группу.
* Принимает параметр \<cwd\> (по умолчанию используется путь \<to\>).
* Параметры \<include_paths\>, \<exclude_paths\>, \<owner\>, \<group\>, \<to\> определяются в контексте.
* Параметр \<to\> по умолчанию соответствует \<cwd\>.
* Если собирается не scratch: в контексте обязательно использование хотя бы одной из директив **before** или **after**, где:
    * директива определяет порядок применения артефакта (до или после);
    * значение определяет стадию (install или setup).

### Примеры

##### export
```ruby
dimg do
  docker.from 'image:tag'

  artifact do
    shell.build_artifact.run 'command1', 'command2'

    export '/artifact' do
      before 'install'
      to '/app'
    end
  end

  artifact do
    shell.build_artifact.run 'command3', 'command4'

    export '/artifact/assets' do
      after 'setup'
      to '/app'
    end
  end
end
```

##### import
```ruby
dimg do
  docker.from 'image:tag'

  artifact('artifact-a') do
    shell.build_artifact.run 'command1', 'command2'
  end

  artifact('artifact-b') do
    shell.build_artifact.run 'command3', 'command4'
  end

  import('artifact-a', '/artifact') do
    before 'install'
    to '/app'
  end

  import('artifact-b', '/artifact/assets') do
    after 'setup'
    to '/app'
  end
end
```

#### Собрать scratch образ
```ruby
dimg_group do
  artifact do
    docker.from 'image:tag'
    shell.build_artifact.run 'command1', 'command2'

    export '/' do
      to '/app'
    end
  end

  dimg
end
```
